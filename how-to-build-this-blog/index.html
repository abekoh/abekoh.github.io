<!doctype html>

<html lang="en" class="h-100">
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="generator" content="Hugo 0.61.0" />
  <link rel="stylesheet" href="https://blog.abekoh.dev/css/bootstrap.min.css">
  
  
  <title>Hugo, Github Pages, CircleCIつかってブログ構築 | abekoh&#39;s tech note</title>
  <style>
.container {
  max-width: 700px;
}
#nav a {
  font-weight: bold;
  color: inherit;
}
#nav a.nav-link-active {
  background-color: #212529;
  color: #fff;
}
#nav-border {
  border-bottom: 1px solid #212529;
}
#main {
  margin-top: 1em;
  margin-bottom: 4em;
}
#home-jumbotron {
  background-color: inherit;
}
#footer .container {
  padding: 1em 0;
}
#footer a {
  color: inherit;
  text-decoration: underline;
}
.font-125 {
  font-size: 125%;
}
.tag-btn {
  margin-bottom: 0.3em;
}
pre {
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  padding: 16px;
}
pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  background-color: transparent;
  border-radius: 0;
}
code {
  padding: 2px 4px;
  font-size: 90%;
  color: #c7254e;
  background-color: #f9f2f4;
  border-radius: 4px;
}
img,
iframe,
embed,
video,
audio {
  max-width: 100%;
}
.card-img,
.card-img-top,
.card-img-bottom {
  width: initial;
}
</style>
</head>
  <body class="d-flex flex-column h-100">
    <div id="nav-border" class="container">
  <nav id="nav" class="nav justify-content-center">
  
  
  
    
    
      
      
      
      
      
        
      
    
    
    <a class="nav-link " href="/"><i data-feather="home"></i> Home</a>
  
    
    
      
      
      
      
      
       
        
        
      
    
    
    <a class="nav-link nav-link-active" href="/post/"><i data-feather="edit"></i> Blog</a>
  
    
    
      
      
      
      
      
        
      
    
    
    <a class="nav-link " href="/tags/"><i data-feather="tag"></i> Tags</a>
  
    
    
      
      
      
      
      
        
      
    
    
    <a class="nav-link " href="/about/"><i data-feather="smile"></i> About</a>
  
    
    
      
      
      
      
      
        
      
    
    
    <a class="nav-link " href="/index.xml"><i data-feather="rss"></i> RSS</a>
  
  </nav>
</div>

    <div class="container">
      <main id="main">
        

<h1>Hugo, Github Pages, CircleCIつかってブログ構築</h1>


<i data-feather="calendar"></i> <time datetime="2019-12-14">2019/12/14</time>

  <br>
  <i data-feather="tag"></i>
  
  
  <a class="btn btn-sm btn-outline-dark tag-btn" href="https://blog.abekoh.dev/tags/hugo">Hugo</a>
  
  
  <a class="btn btn-sm btn-outline-dark tag-btn" href="https://blog.abekoh.dev/tags/circleci">CircleCI</a>
  
  
  <a class="btn btn-sm btn-outline-dark tag-btn" href="https://blog.abekoh.dev/tags/github-pages">Github Pages</a>
  
  
  <a class="btn btn-sm btn-outline-dark tag-btn" href="https://blog.abekoh.dev/tags/google-domains">Google Domains</a>
  

<br><br>
<p>このブログの構築メモ。
やっぱりブログもGitHubで管理できたらいいなーと探したら、この組み合わせで簡単にいい感じにできそうだったのでやってみた。</p>
<h2 id="hugo">Hugoとは</h2>
<p><a href="https://gohugo.io/">https://gohugo.io/</a></p>
<p>Go製の静的サイト生成ツール。
とにかく簡単にブログがつくれる。ブログじゃなくてもポートフォリオサイトやOSSプロジェクトページなんかもいける。</p>
<p>Markdownでかけるのも嬉しい。非常にGitHubフレンドリーな感じ。</p>
<p>個人的に惜しいと思う点は、超スタンダードな感じのテーマの多くがGPLなところ。
編集中のはPrivateにする場合ここが引っかかってしまうので、なくなくそれらを弾いてテーマ選びました。</p>
<p>とりあえずこれを無編集で使ってます。</p>
<p><a href="https://github.com/zwbetz-gh/vanilla-bootstrap-hugo-theme">https://github.com/zwbetz-gh/vanilla-bootstrap-hugo-theme</a></p>
<h2 id="heading">構成</h2>
<p><img src="/images/circleci-github-hugo.png" alt="全体構成"></p>
<p>Github Pagesの機能をつかって公開するんですが、Hugoのソース自体はPrivateで管理。
abekoh.github.ioにはCircleCIがmaster pushするだけ。</p>
<p>CircleCI選んだ理由は、とりあえず有名でモダンなやつ試したかったから。
最近だとGithub Actionsがよかったかな、と後から思ったけどまぁいいか。</p>
<h2 id="circleci">CircleCI設定</h2>
<p>hugoのビルドは、Orbがあったのでそれを使う。
Orbはビルド手順のテンプレートみたいなの。</p>
<p><a href="https://circleci.com/orbs/registry/orb/circleci/hugo">https://circleci.com/orbs/registry/orb/circleci/hugo</a></p>
<p>その後、Github Pagesへのpushは手動で設定。
このあたり参考にさせていただきました。</p>
<ul>
<li><a href="https://qiita.com/sterashima78/items/ddb8161eb6345d9fb15b">CircleCIでgithub pagesに自動デプロイする</a></li>
<li><a href="https://t32k.me/mol/log/hugo-circleci-ghpages-2018/">CircleCIでHugoを実行してGitHub Pagesにデプロイ</a></li>
</ul>
<p>引っかかったのが、ssh鍵設定してもcloneできない問題。
<a href="https://discuss.circleci.com/t/git-clone-fails-in-circle-2-0/15211">こちら</a>参考に、<code>StrictHostKeyChecking=no</code>にすれば解決しました。</p>
<p>最終的に.circleci/config.ymlはこんな感じ。
なれてきたらまた直していきたい。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">version: <span style="color:#ae81ff">2.1</span>
orbs:
  hugo: circleci/hugo@<span style="color:#ae81ff">0.4</span><span style="color:#ae81ff">.1</span>
jobs:
  deploy:
    docker:
      - image: cibuilds/base
    steps:
      - add_ssh_keys:
          <span style="color:#75715e"># CirlceCIのSSH Permissionsに設定したSSH Keyのfingerprintを設定</span>
          fingerprints:
            - <span style="color:#e6db74">&#34;SO:ME:FIN:G:ER:PR:IN:T&#34;</span>
      <span style="color:#75715e"># ビルドしたworkspaceをもってくる</span>
      - attach_workspace:
          at: .
      - deploy:
          name: deploy to Github Pages
          command: <span style="color:#e6db74">|
</span><span style="color:#e6db74">           </span><span style="color:#e6db74"> </span><span style="color:#e6db74"># ssh警告無視</span>
            echo <span style="color:#e6db74">&#34;HostName github.com&#34;</span> &gt;&gt; ~/.ssh/config
            echo <span style="color:#e6db74">&#34;StrictHostKeyChecking no&#34;</span> &gt;&gt; ~/.ssh/config

            DEPLOY_DIR=deploy
            <span style="color:#75715e"># USER_EMAILはCircleCIのEnvironment Variablesで設定</span>
            git config --global user.email $USER_EMAIL
            git config --global user.name $CIRCLE_USERNAME
            git clone git@github.com:abekoh/abekoh.github.io.git $DEPLOY_DIR

            cd $DEPLOY_DIR
            rm -vrf ./*
            cp -v -R ../public/* ./

            <span style="color:#75715e"># ドメイン設定</span>
            echo <span style="color:#e6db74">&#34;blog.abekoh.dev&#34;</span> &gt; CNAME

            git add -f .
            git commit -m <span style="color:#e6db74">&#34;Deploy #$CIRCLE_BUILD_NUM from CircleCI [ci skip]&#34;</span>
            git push origin master -f
workflows:
  version: <span style="color:#ae81ff">2.1</span>
  main:
    jobs:
      - hugo/build:
          <span style="color:#75715e"># TODO: HTMLチェックをonに</span>
          html-proofer: <span style="color:#66d9ef">false</span>
      <span style="color:#75715e"># masterマージ時のみデプロイ</span>
      - deploy:
          requires:
            - hugo/build
          filters:
            branches:
              only: master
</code></pre></div><h2 id="heading-1">ドメイン設定</h2>
<p>ついでにドメインも取得してみたので設定。</p>
<p>Google Domainsで、devドメインつくりました。
年間1200円、安いですね。</p>
<p><img src="/images/google-domains-cname-config.png" alt="Google Domains設定">
このようにCNAME設定して、</p>
<p><img src="/images/github-pages-domain-config.png" alt="Github Pages">
abekoh/abekoh.github.ioのSettingsでドメイン設定するだけ。</p>
<p>なお、CNAMEファイルがpush時に毎回消えてしまうような設定になっているので、.cricleci/config.ymlのpipelineのとおりCNAMEを毎回作成するようにしています。</p>
<h2 id="heading-2">感想</h2>
<p>やっぱりGitHub上で完結できるのよいですね。書きたいネタをIssueに登録、PR作って解決という流れで一人で運用ができて楽しい。</p>



      </main>
    </div>
    
<footer id="footer" class="mt-auto text-center text-muted">
  <div class="container">
    Made with <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/zwbetz-gh/vanilla-bootstrap-hugo-theme">Vanilla</a>
  </div>
</footer>

    <script src="https://blog.abekoh.dev/js/feather.min.js"></script>
<script>
  feather.replace()
</script>


    
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-154358525-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  </body>
</html>